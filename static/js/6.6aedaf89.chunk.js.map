{"version":3,"sources":["pages/Pose.jsx"],"names":["console","warn","faceDetectionIntervalId","faceDetection","UserMasks","Pose","useState","x","y","w","h","center","setCenter","videoRef","useRef","setMask","media","useContext","MediaContext","onResults","image","detections","detection","boundingBox","L","landmarks","xCenter","yCenter","width","height","a","FaceDetection","locateFile","file","window","setOptions","selfieMode","model","minDetectionConfidence","initialize","setInterval","current","send","useEffect","ready","start","document","querySelector","srcObject","localStream","play","clearInterval","validRange","Math","max","min","warningRange","dangerRange","message","abs","id","md","stream","style","transform","isLocal","variant","now","Range","value","className","controlId","label","Select","onChange","target","defaultValue","settings","mask","map","v","k"],"mappings":"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","file":"static/js/6.6aedaf89.chunk.js","sourcesContent":["//https://github.com/google/mediapipe/issues/2346#issuecomment-888062233\r\n\r\nimport { useState, useRef, useEffect, useContext } from 'react'\r\nimport { Row, Col, ProgressBar, FloatingLabel, Form } from 'react-bootstrap'\r\nimport { MediaContext } from 'utils/ctx_mediadevices'\r\nimport { FaceDetection } from '@mediapipe/face_detection'\r\n\r\nimport MD from 'utils/md'\r\nimport Video from 'partials/video'\r\n\r\nconsole.warn = ()=>{}\r\nlet faceDetection = null;\r\nlet faceDetectionIntervalId;\r\n\r\nconst UserMasks = [\r\n    'None',\r\n    'Face',\r\n    'Torso',\r\n    'Body'\r\n];\r\n\r\nexport default function Pose() {\r\n    let [center, setCenter] = useState({x:0, y:0, w:0, h:0});\r\n    const videoRef = useRef(null);\r\n\r\n    const [mask, setMask] = useState('None');\r\n    const media = useContext(MediaContext);\r\n\r\n    useEffect(() => {\r\n        \r\n        if(!media.ready) \r\n        return;\r\n        \r\n        start();\r\n\r\n        videoRef.current = document.querySelector(\"#pose video\");\r\n        videoRef.current.srcObject = media.localStream;\r\n        videoRef.current.play();\r\n\r\n        return () => {\r\n            clearInterval(faceDetectionIntervalId);\r\n        };\r\n\r\n    }, [media.ready, media.localStream]);\r\n\r\n    function onResults({image, detections}) {\r\n        \r\n        for(let detection of detections) {\r\n            const { L, boundingBox, landmarks } = detection;\r\n            setCenter({\r\n                x:boundingBox.xCenter, y:boundingBox.yCenter, w:boundingBox.width, h:boundingBox.height\r\n            });\r\n        }\r\n    }\r\n\r\n    async function start(){\r\n\r\n        faceDetection = new FaceDetection({\r\n            locateFile: (file) => {\r\n              return `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.4.1628005423/${file}`;\r\n            },\r\n        });\r\n        window.faceDetection = faceDetection; \r\n        faceDetection.setOptions( {\r\n            selfieMode: true,\r\n            model: \"short\",\r\n            minDetectionConfidence: 0.5,\r\n        });\r\n\r\n        faceDetection.onResults(onResults);\r\n        await faceDetection.initialize();\r\n\r\n        faceDetectionIntervalId = setInterval(async () => {\r\n            if(!videoRef.current){\r\n                return;\r\n            }\r\n            try{\r\n                await faceDetection.send({\r\n                    image: videoRef.current,\r\n                });\r\n            }catch(e){}\r\n        }, 120);\r\n    }\r\n\r\n    let validRange = Math.max(0,Math.min(100, 100 - center.w*400)),\r\n        warningRange = Math.max(0,Math.min(100, center.w*100)),\r\n        dangerRange = Math.max(0,Math.min(100, 100 - validRange - warningRange));\r\n\r\n    // Intro message for the pose detection assesment step\r\n    let message = `\r\n        The pose detection step is used to detect the pose of the person in the image. Position yourself centered on the image within the green valid range.\r\n        If the conditions are not met, reposition yourself or the camera.\r\n        ${(center.w > .3) ? '* ❌ You are too close to the camera.': '* ✔️ Distance to camera looks good.'}\r\n        ${(center.y - center.h < 0.0)\r\n            ? '* ❌ You are too far from the camera.'\r\n        :(center.y - center.h < 0.13)\r\n            ? '* ⚠️ Your face is too near to the top margin.' \r\n            : '* ✔️ Got enough space on top.'\r\n        }\r\n        ${(Math.abs(center.x - .5) > validRange*.01 ) \r\n            ?`* ❌ You are not centered at all.` \r\n        :(Math.abs(center.x - .5) > warningRange*.01 )\r\n            ?'* ⚠️ Not enough margin of movement.'\r\n            :'* ✔️ You got enough space on the sides'\r\n        }\r\n    `;\r\n\r\n    return <>\r\n        <div id='pose'>\r\n        <h3 className=\"pt-2\"><b>Positioning in frame</b></h3>\r\n            <Row>\r\n            <Col md={6}>\r\n                <Video id=\"local-pose\" stream={media.localStream}  style={{ transform: \"rotateY(180deg)\", width:\"100%\" }} isLocal={true} />\r\n                <ProgressBar>\r\n                    <ProgressBar variant = \"danger\"  key = {1} now = {dangerRange*.5} />\r\n                    <ProgressBar variant = \"warning\" key = {2} now = {warningRange*.5} />\r\n                    <ProgressBar variant = \"success\" key = {3} now = {validRange} />\r\n                    <ProgressBar variant = \"warning\" key = {4} now = {warningRange*.5} />\r\n                    <ProgressBar variant = \"danger\"  key = {5} now = {dangerRange*.5} />\r\n                </ProgressBar>\r\n                <Form.Range id=\"range\" value={center.x * 100}/>\r\n            </Col>\r\n            <Col md={6}>\r\n\r\n                {<FloatingLabel className=\"pb-1\" controlId=\"floatingSelect\" label={<span> <i className=\"bi bi-mask\" /> Mask</span>}>\r\n                <Form.Select onChange={({target}) => {\r\n                    media.setMask(target.value);\r\n                    setMask(target.value);\r\n                }} defaultValue={ media.settings.mask }>\r\n                {UserMasks.map((v, k) => <option key={k} value={v}>{v}</option>)}\r\n                </Form.Select>\r\n                </FloatingLabel>}\r\n\r\n                <MD className=\"user-select-none\">{message}</MD>\r\n            </Col>\r\n\r\n            </Row>\r\n        </div>\r\n\r\n    <style global jsx>{`\r\n        @import \"src/variables.scss\";\r\n\r\n        @media only screen and (orientation: landscape) and (max-height: 671px) {           \r\n            #pose .row{\r\n                flex-direction: row !important;\r\n                .col{\r\n                    align-self: start;\r\n                }\r\n            }\r\n        }  \r\n    `}</style>\r\n    </>\r\n}"],"sourceRoot":""}